<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Item Sales Builder - Financial Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar-shadow { box-shadow: 2px 0 4px rgba(0,0,0,0.1); }
        .hover-bg:hover { background-color: #f9fafb; }
        .nav-active { background-color: #dbeafe; color: #1d4ed8; }
        .metric-card { transition: all 0.2s ease; }
        .metric-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .category-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .selected-metric { border-color: #3b82f6 !important; background-color: #eff6ff !important; }
        .tab-active { border-color: #3b82f6 !important; color: #3b82f6 !important; }
        .drop-zone { border: 2px dashed #d1d5db; transition: all 0.2s ease; }
        .drop-zone.active { border-color: #3b82f6; background-color: #eff6ff; }
        .kpi-widget { background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%); }
        .chart-container { height: 300px; }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white sidebar-shadow">
            <div class="p-4">
                <!-- User Profile -->
                <div class="flex items-center mb-6 pb-4 border-b border-gray-200">
                    <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center mr-3">
                        <span class="text-white text-sm font-medium">R</span>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">Ruby of the Rockies</div>
                        <div class="text-xs text-gray-500">Store Owner</div>
                    </div>
                    <svg class="w-4 h-4 ml-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </div>
                
                <!-- Search -->
                <div class="relative mb-6">
                    <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <input type="text" placeholder="Search" class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                
                <!-- Navigation -->
                <nav class="space-y-1">
                    <a href="home.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover-bg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        </svg>
                        Home
                    </a>
                    
                    <a href="index.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover-bg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
                        </svg>
                        Items & services
                    </a>
                    
                    <!-- Reports Section -->
                    <a href="reports.html" class="flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md hover-bg">
                        <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Reports
                    </a>

                    <!-- Custom Reports Section (Active) -->
                    <div class="nav-active rounded-md">
                        <a href="custom-reports.html" class="flex items-center px-3 py-2 text-sm font-medium">
                            <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                            </svg>
                            Custom Reports
                        </a>
                        <!-- Sub-navigation for Custom Reports -->
                        <div class="ml-8 mt-1 space-y-1">
                            <a href="custom-item-reports.html" class="block px-3 py-1 text-xs text-blue-800 font-medium bg-blue-100 rounded">Custom Item Reports</a>
                            <a href="custom-sales-reports.html" class="block px-3 py-1 text-xs text-blue-600 hover:text-blue-800">Custom Sales Reports</a>
                            <a href="custom-financial-reports.html" class="block px-3 py-1 text-xs text-blue-600 hover:text-blue-800">Custom Financial Reports</a>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col">
            <!-- Header -->
            <div class="bg-white border-b border-gray-200 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900">Custom Item Sales Builder</h1>
                        <p class="text-sm text-gray-600 mt-1">Build a custom report with your preferred metrics, filters, and visualizations</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button class="flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm hover-bg">
                            Cancel
                        </button>
                        <button class="flex items-center px-3 py-2 border border-gray-300 rounded-md text-sm hover-bg">
                            Preview
                        </button>
                        <button class="bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-blue-700">
                            Save Report
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex flex-1">
                <!-- Report Builder Area -->
                <div class="flex-1 p-6">
                    <!-- Report Details -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                        <h2 class="text-lg font-medium text-gray-900 mb-4">Report Details</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Report Name</label>
                                <input type="text" placeholder="Enter report name..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                <textarea placeholder="Describe what this report shows..." rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Report Builder Canvas -->
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-lg font-medium text-gray-900">Report Canvas</h2>
                            <div class="flex items-center space-x-2">
                                <button id="clearAllBtn" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border border-gray-300 rounded">Clear All</button>
                                <button class="text-sm text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-300 rounded">Auto Layout</button>
                            </div>
                        </div>

                        <!-- Report Canvas Content -->
                        <div id="reportCanvasContent">
                            <!-- KPI Widgets Row -->
                            <div class="mb-8" id="kpiSection">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Key Performance Indicators</h3>
                                <div class="grid grid-cols-4 gap-4" id="kpiWidgets">
                                    <!-- KPI Widget 1 - Gross Sales -->
                                    <div class="kpi-widget p-4 rounded-lg border border-gray-200 text-center">
                                        <div class="text-2xl font-bold text-green-600">$24,580</div>
                                        <div class="text-sm text-gray-600">Gross Sales</div>
                                        <div class="text-xs text-green-600 mt-1">‚Üó +12.5%</div>
                                    </div>
                                    
                                    <!-- KPI Widget 2 - Net Sales -->
                                    <div class="kpi-widget p-4 rounded-lg border border-gray-200 text-center">
                                        <div class="text-2xl font-bold text-blue-600">$22,340</div>
                                        <div class="text-sm text-gray-600">Net Sales</div>
                                        <div class="text-xs text-blue-600 mt-1">‚Üó +8.3%</div>
                                    </div>
                                    
                                    <!-- KPI Widget 3 - Items Sold -->
                                    <div class="kpi-widget p-4 rounded-lg border border-gray-200 text-center">
                                        <div class="text-2xl font-bold text-purple-600">1,247</div>
                                        <div class="text-sm text-gray-600">Items Sold</div>
                                        <div class="text-xs text-purple-600 mt-1">‚Üó +15.2%</div>
                                    </div>
                                    
                                    <!-- KPI Widget 4 - Transaction Count -->
                                    <div class="kpi-widget p-4 rounded-lg border border-gray-200 text-center">
                                        <div class="text-2xl font-bold text-orange-600">342</div>
                                        <div class="text-sm text-gray-600">Transactions</div>
                                        <div class="text-xs text-orange-600 mt-1">‚Üó +6.7%</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Charts Section -->
                            <div class="mb-8" id="chartsSection">
                                <h3 class="text-sm font-medium text-gray-700 mb-3">Charts & Visualizations</h3>
                                <div class="grid grid-cols-2 gap-6">
                                    <!-- Sales Trend Chart -->
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-900 mb-3">Sales Trend (Last 7 Days)</h4>
                                        <div class="chart-container">
                                            <canvas id="salesTrendChart"></canvas>
                                        </div>
                                    </div>
                                    
                                    <!-- Category Breakdown -->
                                    <div class="border border-gray-200 rounded-lg p-4">
                                        <h4 class="text-sm font-medium text-gray-900 mb-3">Sales by Category</h4>
                                        <div class="chart-container">
                                            <canvas id="categoryChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Data Table Section -->
                            <div class="mb-6" id="tableSection">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">Detailed Item Sales</h3>
                                    <div class="flex items-center space-x-2">
                                        <button id="addColumnBtn" class="text-xs text-blue-600 hover:text-blue-800 px-2 py-1 border border-blue-300 rounded">+ Add Column</button>
                                        <button id="editTableBtn" class="text-xs text-gray-600 hover:text-gray-800 px-2 py-1 border border-gray-300 rounded">Edit Table</button>
                                    </div>
                                </div>
                                <div class="border border-gray-200 rounded-lg overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200" id="reportTable">
                                        <thead class="bg-gray-50" id="tableHeader">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Item Name</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty Sold</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Sales</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Sales</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Discounts</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="tableBody">
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-900">Espresso</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">Beverages</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">156</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$468.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$445.60</td>
                                                <td class="px-4 py-3 text-sm text-red-600">-$22.40</td>
                                            </tr>
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-900">Croissant</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">Pastries</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">89</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$267.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$267.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">$0.00</td>
                                            </tr>
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-900">Latte</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">Beverages</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">234</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$1,170.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$1,111.50</td>
                                                <td class="px-4 py-3 text-sm text-red-600">-$58.50</td>
                                            </tr>
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-900">Sandwich - Turkey</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">Food</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">67</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$603.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$603.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">$0.00</td>
                                            </tr>
                                            <tr>
                                                <td class="px-4 py-3 text-sm text-gray-900">Muffin - Blueberry</td>
                                                <td class="px-4 py-3 text-sm text-gray-600">Pastries</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">43</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$129.00</td>
                                                <td class="px-4 py-3 text-sm text-gray-900">$116.10</td>
                                                <td class="px-4 py-3 text-sm text-red-600">-$12.90</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Drop Zones for Additional Widgets -->
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center drop-zone">
                                <svg class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <h3 class="text-lg font-medium text-gray-900 mb-2">Add More Widgets</h3>
                                <p class="text-gray-600">Drag and drop metrics from the right panel to add more visualizations</p>
                            </div>
                        </div>

                        <!-- Empty Canvas State -->
                        <div id="emptyCanvasState" class="hidden text-center py-16">
                            <svg class="h-16 w-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <h3 class="text-xl font-medium text-gray-900 mb-2">Start Building Your Report</h3>
                            <p class="text-gray-600 mb-6">Select metrics from the right panel to automatically build your custom data table.</p>
                        </div>

                        <!-- Dynamic Table Container -->
                        <div id="dynamicTableContainer" class="hidden">
                            <div class="mb-6" id="dynamicTableSection">
                                <div class="flex items-center justify-between mb-3">
                                    <h3 class="text-sm font-medium text-gray-700">Custom Report Data</h3>
                                    <div class="flex items-center space-x-2">
                                        <button id="editDynamicTableBtn" class="text-xs text-gray-600 hover:text-gray-800 px-2 py-1 border border-gray-300 rounded">Edit Table</button>
                                    </div>
                                </div>
                                <div class="border border-gray-200 rounded-lg overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200" id="dynamicReportTable">
                                        <thead class="bg-gray-50" id="dynamicTableHeader">
                                            <tr>
                                                <!-- Dynamic columns will be added here -->
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200" id="dynamicTableBody">
                                            <!-- Dynamic rows will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Panel - Metrics Selection -->
                <div class="w-80 bg-white border-l border-gray-200 overflow-auto">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900">Build Your Report</h3>
                            <span class="text-xs text-gray-500">0 selected</span>
                        </div>

                        <!-- Tabs -->
                        <div class="border-b border-gray-200 mb-4">
                            <nav class="-mb-px flex">
                                <button class="py-2 px-3 mr-2 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">
                                    Metrics
                                </button>
                                <button class="py-2 px-3 mr-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm">
                                    Filters
                                </button>
                                <button class="py-2 px-3 mr-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm">
                                    Group By
                                </button>
                                <button class="py-2 px-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-sm">
                                    Charts
                                </button>
                            </nav>
                        </div>

                        <!-- Metrics Panel -->
                        <div id="metricsPanel" class="space-y-4 max-h-96 overflow-y-auto">
                            <!-- Item Info Category -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üì¶ Item Info</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Itemization Type</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Type of item</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Item Name</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Name of the item</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">GTIN</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Global Trade Item Number</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">SKU</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Stock Keeping Unit</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Location</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Store location</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Menu</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Menu category</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Categories -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üìÇ Categories</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Categories</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Item categories</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Reporting Category</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Category for reporting</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Category Rollup</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Rolled up categories</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Sales Metrics -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üí∞ Sales Metrics</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Gross Sales</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Total sales before deductions</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Net Sales</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Sales after returns and discounts</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Tax</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Tax amount</p>
                                    </div>
                                    <div class="metric-card p-2 border border-blue-500 bg-blue-50 rounded cursor-pointer">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-900">Qty</span>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Sales</span>
                                        </div>
                                        <p class="text-xs text-blue-700 mt-1">Quantity</p>
                                    </div>
                                    <div class="metric-card p-2 border border-blue-500 bg-blue-50 rounded cursor-pointer">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-900">Channel</span>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Sales</span>
                                        </div>
                                        <p class="text-xs text-blue-700 mt-1">Sales channel</p>
                                    </div>
                                    <div class="metric-card p-2 border border-blue-500 bg-blue-50 rounded cursor-pointer">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-900">Transaction Count</span>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Sales</span>
                                        </div>
                                        <p class="text-xs text-blue-700 mt-1">Number of transactions</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Items Sold</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Number of items sold</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Discounts -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üè∑Ô∏è Discounts</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-blue-500 bg-blue-50 rounded cursor-pointer">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium text-blue-900">Amount Discounted</span>
                                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Sales</span>
                                        </div>
                                        <p class="text-xs text-blue-700 mt-1">Total amount discounted</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Discounts Applied</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Number of discounts applied</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Discount Rate</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Percentage of sales discounted</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance Metrics -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üìà Performance</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Average Order Value</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Average value per transaction</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Items per Transaction</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Average items per order</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Sales Growth</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Period over period growth</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Market Share</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Item's share of category sales</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Returns & Refunds -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">‚Ü©Ô∏è Returns</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Returns Amount</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Total value of returns</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Return Rate</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Percentage of items returned</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Refunds Processed</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Number of refunds issued</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Inventory Metrics -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üì¶ Inventory</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Stock Level</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Current inventory count</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Turnover Rate</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">How quickly inventory moves</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Days of Supply</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Days until stock runs out</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Charts
        document.addEventListener('DOMContentLoaded', function() {
            // Sales Trend Chart
            const salesTrendCtx = document.getElementById('salesTrendChart').getContext('2d');
            new Chart(salesTrendCtx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Daily Sales',
                        data: [3200, 2800, 3600, 4100, 3800, 4500, 3900],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#f3f4f6'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });

            // Category Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Beverages', 'Food', 'Pastries', 'Merchandise'],
                    datasets: [{
                        data: [45, 30, 20, 5],
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });

            // Tab switching functionality
            const tabs = document.querySelectorAll('.border-b-2');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => {
                        t.classList.remove('border-blue-500', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    
                    // Add active class to clicked tab
                    this.classList.remove('border-transparent', 'text-gray-500');
                    this.classList.add('border-blue-500', 'text-blue-600');
                    
                    // Show/hide panels based on tab
                    const tabText = this.textContent.trim();
                    showPanel(tabText);
                });
            });

            // Metric card selection - Enhanced for dynamic table building
            const metricCards = document.querySelectorAll('.metric-card');
            let selectedCount = 0;
            let selectedMetrics = [];
            
            metricCards.forEach(card => {
                card.addEventListener('click', function() {
                    const metricName = this.querySelector('.text-sm.font-medium').textContent;
                    
                    if (this.classList.contains('selected-metric')) {
                        // Deselect
                        this.classList.remove('selected-metric');
                        selectedCount--;
                        selectedMetrics = selectedMetrics.filter(m => m !== metricName);
                        removeColumnFromDynamicTable(metricName);
                    } else {
                        // Select
                        this.classList.add('selected-metric');
                        selectedCount++;
                        selectedMetrics.push(metricName);
                        addColumnToDynamicTable(metricName);
                    }
                    
                    // Update counter
                    document.querySelector('.text-xs.text-gray-500').textContent = `${selectedCount} selected`;
                    
                    // Show/hide dynamic table based on selections
                    if (selectedCount > 0) {
                        document.getElementById('emptyCanvasState').classList.add('hidden');
                        document.getElementById('dynamicTableContainer').classList.remove('hidden');
                        document.getElementById('reportCanvasContent').classList.add('hidden');
                    } else {
                        document.getElementById('emptyCanvasState').classList.remove('hidden');
                        document.getElementById('dynamicTableContainer').classList.add('hidden');
                        document.getElementById('reportCanvasContent').classList.add('hidden');
                    }
                });
            });

            // Drop zone interactions
            const dropZone = document.querySelector('.drop-zone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('active');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('active');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('active');
                // Add widget logic here
                addWidget();
            });

            // Make metric cards draggable
            metricCards.forEach(card => {
                card.draggable = true;
                card.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.querySelector('.text-sm.font-medium').textContent);
                });
            });

            // Clear All functionality
            document.getElementById('clearAllBtn').addEventListener('click', function() {
                // Hide current canvas content
                document.getElementById('reportCanvasContent').classList.add('hidden');
                // Hide dynamic table
                document.getElementById('dynamicTableContainer').classList.add('hidden');
                // Show empty canvas state
                document.getElementById('emptyCanvasState').classList.remove('hidden');
                // Reset all selections
                selectedCount = 0;
                selectedMetrics = [];
                document.querySelector('.text-xs.text-gray-500').textContent = '0 selected';
                // Clear all selected metrics
                document.querySelectorAll('.metric-card').forEach(card => {
                    card.classList.remove('selected-metric');
                });
                // Clear dynamic table
                document.getElementById('dynamicTableHeader').querySelector('tr').innerHTML = '';
                document.getElementById('dynamicTableBody').innerHTML = '';
            });

            // Add Column functionality
            document.getElementById('addColumnBtn').addEventListener('click', function() {
                showColumnSelector();
            });

            // Edit Table functionality
            document.getElementById('editTableBtn').addEventListener('click', function() {
                toggleTableEditMode();
            });
        });

        function showPanel(tabName) {
            const metricsPanel = document.getElementById('metricsPanel');
            
            if (tabName === 'Metrics') {
                // Don't replace the metrics panel content, it should stay as is
                return;
            } else if (tabName === 'Filters') {
                metricsPanel.innerHTML = `
                    <div class="space-y-4">
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h4 class="font-medium text-sm mb-3">Date Range</h4>
                            <div class="space-y-2">
                                <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                            </div>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h4 class="font-medium text-sm mb-3">Categories</h4>
                            <div class="space-y-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span class="text-sm">Beverages</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span class="text-sm">Food</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-2" checked>
                                    <span class="text-sm">Pastries</span>
                                </label>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'Group By') {
                metricsPanel.innerHTML = `
                    <div class="space-y-4">
                        <div class="p-4 border border-gray-200 rounded-lg">
                            <h4 class="font-medium text-sm mb-3">Group By Options (Select Multiple)</h4>
                            <div class="space-y-3">
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="groupBy" value="category" class="mr-3" id="categoryHierarchical">
                                    <div>
                                        <div class="text-sm font-medium">Category (Hierarchical)</div>
                                        <div class="text-xs text-gray-600">Shows parent-child category structure to avoid double counting</div>
                                    </div>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="groupBy" value="reportingCategory" class="mr-3">
                                    <div>
                                        <div class="text-sm font-medium">Reporting Category</div>
                                        <div class="text-xs text-gray-600">Groups by primary reporting category only</div>
                                    </div>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="groupBy" value="itemName" class="mr-3">
                                    <div>
                                        <div class="text-sm font-medium">Item Name</div>
                                        <div class="text-xs text-gray-600">Individual item breakdown</div>
                                    </div>
                                </label>
                                <label class="flex items-center cursor-pointer">
                                    <input type="checkbox" name="groupBy" value="location" class="mr-3">
                                    <div>
                                        <div class="text-sm font-medium">Location</div>
                                        <div class="text-xs text-gray-600">Group by store location</div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <!-- Metrics Selection for Group By -->
                        <div class="space-y-4 max-h-96 overflow-y-auto" id="groupByMetricsPanel">
                            <!-- Item Info Category -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üì¶ Item Info</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="itemName">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Item Name</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Name of the item</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="location">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Location</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Store location</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Categories -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üìÇ Categories</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="categories" data-hierarchy="true">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Categories</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Build hierarchical category view</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="reportingCategory">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Reporting Category</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Category for reporting</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Sales Metrics -->
                            <div class="category-section">
                                <div class="category-header text-white px-3 py-2 rounded-t-lg">
                                    <h4 class="font-medium text-sm">üí∞ Sales Metrics</h4>
                                </div>
                                <div class="bg-white border border-t-0 rounded-b-lg p-3 space-y-2">
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="grossSales">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Gross Sales</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Total sales before deductions</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="netSales">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Net Sales</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Sales after returns and discounts</p>
                                    </div>
                                    <div class="metric-card p-2 border border-gray-200 rounded cursor-pointer hover-bg" data-metric="qty">
                                        <div class="flex items-center justify-between">
                                            <span class="text-sm font-medium">Qty</span>
                                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                            </svg>
                                        </div>
                                        <p class="text-xs text-gray-600 mt-1">Quantity sold</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add event listeners for Group By metrics
                setTimeout(() => {
                    const groupByMetricCards = document.querySelectorAll('#groupByMetricsPanel .metric-card');
                    groupByMetricCards.forEach(card => {
                        card.addEventListener('click', function() {
                            const metricName = this.dataset.metric;
                            const isHierarchy = this.dataset.hierarchy === 'true';
                            
                            if (isHierarchy && metricName === 'categories') {
                                buildHierarchicalView();
                            } else {
                                buildGroupedView(metricName);
                            }
                        });
                    });

                    // Add event listeners for the checkboxes at the top
                    const groupByCheckboxes = document.querySelectorAll('input[name="groupBy"]');
                    console.log('Found checkboxes:', groupByCheckboxes.length);
                    groupByCheckboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', function() {
                            console.log('Checkbox changed:', this.value, 'checked:', this.checked);
                            if (this.checked) {
                                const value = this.value;
                                if (value === 'category') {
                                    console.log('Building hierarchical view...');
                                    buildHierarchicalView();
                                } else {
                                    console.log('Building grouped view for:', value);
                                    buildGroupedView(value);
                                }
                            }
                        });
                    });
                }, 100);
            } else if (tabName === 'Charts') {
                metricsPanel.innerHTML = `
                    <div class="space-y-4">
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover-bg">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-blue-100 rounded mr-3 flex items-center justify-center">
                                    üìä
                                </div>
                                <div>
                                    <div class="font-medium text-sm">Bar Chart</div>
                                    <div class="text-xs text-gray-600">Compare values across categories</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover-bg">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-green-100 rounded mr-3 flex items-center justify-center">
                                    üìà
                                </div>
                                <div>
                                    <div class="font-medium text-sm">Line Chart</div>
                                    <div class="text-xs text-gray-600">Show trends over time</div>
                                </div>
                            </div>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg cursor-pointer hover-bg">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-purple-100 rounded mr-3 flex items-center justify-center">
                                    ü•ß
                                </div>
                                <div>
                                    <div class="font-medium text-sm">Pie Chart</div>
                                    <div class="text-xs text-gray-600">Show proportions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function addWidget() {
            // Simulate adding a new widget
            const kpiWidgets = document.getElementById('kpiWidgets');
            const newWidget = document.createElement('div');
            newWidget.className = 'kpi-widget p-4 rounded-lg border border-gray-200 text-center';
            newWidget.innerHTML = `
                <div class="text-2xl font-bold text-indigo-600">$1,234</div>
                <div class="text-sm text-gray-600">New Metric</div>
                <div class="text-xs text-indigo-600 mt-1">‚Üó +5.0%</div>
            `;
            
            // Replace drop zone with new widget temporarily
            const dropZone = document.querySelector('.drop-zone');
            dropZone.innerHTML = `
                <div class="text-center py-4">
                    <div class="text-green-600 mb-2">‚úì Widget Added!</div>
                    <p class="text-sm text-gray-600">Drag more metrics to add additional widgets</p>
                </div>
            `;
            
            setTimeout(() => {
                dropZone.innerHTML = `
                    <svg class="h-12 w-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Add More Widgets</h3>
                    <p class="text-gray-600">Drag and drop metrics from the right panel to add more visualizations</p>
                `;
            }, 2000);
        }
        function showColumnSelector() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add Column to Table</h3>
                    <div class="space-y-3">
                        <div class="metric-selector p-3 border border-gray-200 rounded cursor-pointer hover:bg-gray-50" data-metric="tax">
                            <div class="font-medium text-sm">Tax</div>
                            <div class="text-xs text-gray-600">Tax amount</div>
                        </div>
                        <div class="metric-selector p-3 border border-gray-200 rounded cursor-pointer hover:bg-gray-50" data-metric="returns">
                            <div class="font-medium text-sm">Returns Amount</div>
                            <div class="text-xs text-gray-600">Total value of returns</div>
                        </div>
                        <div class="metric-selector p-3 border border-gray-200 rounded cursor-pointer hover:bg-gray-50" data-metric="location">
                            <div class="font-medium text-sm">Location</div>
                            <div class="text-xs text-gray-600">Store location</div>
                        </div>
                        <div class="metric-selector p-3 border border-gray-200 rounded cursor-pointer hover:bg-gray-50" data-metric="sku">
                            <div class="font-medium text-sm">SKU</div>
                            <div class="text-xs text-gray-600">Stock Keeping Unit</div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="cancelColumnBtn" class="px-4 py-2 text-gray-700 border border-gray-300 rounded hover:bg-gray-50">Cancel</button>
                        <button id="addColumnConfirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700" disabled>Add Column</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            let selectedMetric = null;
            
            // Handle metric selection
            modal.querySelectorAll('.metric-selector').forEach(selector => {
                selector.addEventListener('click', function() {
                    // Remove selection from others
                    modal.querySelectorAll('.metric-selector').forEach(s => s.classList.remove('bg-blue-50', 'border-blue-500'));
                    // Add selection to clicked
                    this.classList.add('bg-blue-50', 'border-blue-500');
                    selectedMetric = this.dataset.metric;
                    document.getElementById('addColumnConfirmBtn').disabled = false;
                    document.getElementById('addColumnConfirmBtn').classList.remove('opacity-50');
                });
            });
            
            // Handle cancel
            document.getElementById('cancelColumnBtn').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // Handle add column
            document.getElementById('addColumnConfirmBtn').addEventListener('click', function() {
                if (selectedMetric) {
                    addColumnToTable(selectedMetric);
                    document.body.removeChild(modal);
                }
            });
        }

        function addColumnToTable(metric) {
            const tableHeader = document.getElementById('tableHeader').querySelector('tr');
            const tableBody = document.getElementById('tableBody');
            
            // Add header
            const newHeader = document.createElement('th');
            newHeader.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            
            const metricData = {
                tax: 'Tax',
                returns: 'Returns',
                location: 'Location',
                sku: 'SKU'
            };
            
            newHeader.textContent = metricData[metric] || metric;
            tableHeader.appendChild(newHeader);
            
            // Add data to each row
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const newCell = document.createElement('td');
                newCell.className = 'px-4 py-3 text-sm text-gray-900';
                
                // Sample data based on metric
                const sampleData = {
                    tax: ['$23.40', '$13.35', '$58.50', '$30.15', '$6.45'],
                    returns: ['$0.00', '$0.00', '$25.00', '$0.00', '$0.00'],
                    location: ['Main Store', 'Main Store', 'Main Store', 'Main Store', 'Main Store'],
                    sku: ['ESP001', 'CRO001', 'LAT001', 'SAN001', 'MUF001']
                };
                
                newCell.textContent = sampleData[metric][index] || 'N/A';
                row.appendChild(newCell);
            });
        }

        function addColumnToDynamicTable(metricName) {
            const tableHeader = document.getElementById('dynamicTableHeader').querySelector('tr');
            const tableBody = document.getElementById('dynamicTableBody');
            
            // Add header
            const newHeader = document.createElement('th');
            newHeader.className = 'px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
            newHeader.textContent = metricName;
            newHeader.dataset.metric = metricName;
            tableHeader.appendChild(newHeader);
            
            // Enhanced sample data with realistic item categories
            const sampleData = {
                'Item Name': ['Firewood 6 Logs', 'Holiday Candles', 'Camping Coffee', 'Kitchen Towels', 'Outdoor Blanket'],
                'Categories': [
                    'Household, Household Outdoor/Camping',
                    'Merchandise, Merchandise_Holiday, Household', 
                    'Grocery, Grocery Beverages, Household Outdoor/Camping',
                    'Household, Household Kitchen, Merchandise_Home Goods',
                    'Merchandise, Merchandise_Apparel, Household Outdoor/Camping'
                ],
                'Reporting Category': [
                    'Household Outdoor/Camping',
                    'Merchandise_Holiday', 
                    'Grocery Beverages',
                    'Household Kitchen',
                    'Merchandise_Apparel'
                ],
                'Category Rollup': [
                    'Household',
                    'Merchandise, Household', 
                    'Grocery, Household',
                    'Household, Merchandise',
                    'Merchandise, Household'
                ],
                'Gross Sales': ['$89.99', '$24.99', '$12.99', '$15.99', '$45.99'],
                'Net Sales': ['$85.49', '$23.74', '$12.34', '$15.19', '$43.69'],
                'Qty': ['12', '8', '24', '15', '6'],
                'Channel': ['In-Store', 'Online', 'In-Store', 'In-Store', 'Online'],
                'Transaction Count': ['8', '6', '18', '12', '4'],
                'Amount Discounted': ['-$4.50', '-$1.25', '-$0.65', '-$0.80', '-$2.30'],
                'Tax': ['$7.20', '$2.00', '$1.04', '$1.28', '$3.68'],
                'Location': ['Main Store', 'Main Store', 'Main Store', 'Main Store', 'Main Store'],
                'SKU': ['FW001', 'HC002', 'CC003', 'KT004', 'OB005'],
                'GTIN': ['1234567890123', '1234567890124', '1234567890125', '1234567890126', '1234567890127'],
                'Returns Amount': ['$0.00', '$0.00', '$12.99', '$0.00', '$0.00']
            };
            
            // Create rows if they don't exist
            if (tableBody.children.length === 0) {
                for (let i = 0; i < 5; i++) {
                    const row = document.createElement('tr');
                    tableBody.appendChild(row);
                }
            }
            
            // Add data to each row
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const newCell = document.createElement('td');
                newCell.className = 'px-4 py-3 text-sm text-gray-900';
                newCell.dataset.metric = metricName;
                
                const data = sampleData[metricName] || [`Value ${index + 1}`, `Value ${index + 2}`, `Value ${index + 3}`, `Value ${index + 4}`, `Value ${index + 5}`];
                newCell.textContent = data[index] || 'N/A';
                
                // Special styling for multi-category cells
                if (metricName === 'Categories' || metricName === 'Category Rollup') {
                    newCell.className += ' text-xs';
                    if (data[index] && data[index].includes(',')) {
                        newCell.innerHTML = data[index].split(',').map(cat => 
                            `<span class="inline-block bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs mr-1 mb-1">${cat.trim()}</span>`
                        ).join('');
                    }
                }
                
                row.appendChild(newCell);
            });
        }

        function removeColumnFromDynamicTable(metricName) {
            // Remove header
            const headers = document.querySelectorAll('#dynamicTableHeader th[data-metric="' + metricName + '"]');
            headers.forEach(header => header.remove());
            
            // Remove cells
            const cells = document.querySelectorAll('#dynamicTableBody td[data-metric="' + metricName + '"]');
            cells.forEach(cell => cell.remove());
            
            // Remove empty rows if no columns left
            const tableBody = document.getElementById('dynamicTableBody');
            const remainingHeaders = document.querySelectorAll('#dynamicTableHeader th').length;
            if (remainingHeaders === 0) {
                tableBody.innerHTML = '';
            }
        }

        function buildHierarchicalView() {
            // Hide existing content and show hierarchical view
            document.getElementById('reportCanvasContent').classList.add('hidden');
            document.getElementById('emptyCanvasState').classList.add('hidden');
            document.getElementById('dynamicTableContainer').classList.add('hidden');
            
            // Create hierarchical view container
            let hierarchicalContainer = document.getElementById('hierarchicalContainer');
            if (!hierarchicalContainer) {
                hierarchicalContainer = document.createElement('div');
                hierarchicalContainer.id = 'hierarchicalContainer';
                hierarchicalContainer.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6';
                document.querySelector('.flex-1.p-6').appendChild(hierarchicalContainer);
            }
            
            hierarchicalContainer.classList.remove('hidden');
            hierarchicalContainer.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-medium text-gray-900">Hierarchical Category View</h2>
                    <div class="flex items-center space-x-2">
                        <button id="expandAllBtn" class="text-sm text-blue-600 hover:text-blue-800 px-3 py-1 border border-blue-300 rounded">Expand All</button>
                        <button id="collapseAllBtn" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border border-gray-300 rounded">Collapse All</button>
                    </div>
                </div>
                
                <div class="space-y-2" id="hierarchicalTree">
                    <!-- Household Category -->
                    <div class="category-node">
                        <div class="flex items-center justify-between p-3 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100" data-category="Household" data-expanded="true">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-blue-600 expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                <span class="font-medium text-blue-900">üìÅ Household</span>
                            </div>
                            <div class="text-blue-800 font-semibold">$189.97</div>
                        </div>
                        <div class="ml-6 mt-2 space-y-2 category-children">
                            <div class="flex items-center justify-between p-2 bg-white border border-gray-200 rounded">
                                <div class="flex items-center">
                                    <span class="w-4 h-4 mr-2"></span>
                                    <span class="text-sm text-gray-700">‚îú‚îÄ‚îÄ Household Kitchen</span>
                                </div>
                                <span class="text-sm text-gray-600">$15.99</span>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white border border-gray-200 rounded">
                                <div class="flex items-center">
                                    <span class="w-4 h-4 mr-2"></span>
                                    <span class="text-sm text-gray-700">‚îî‚îÄ‚îÄ Household Outdoor/Camping</span>
                                </div>
                                <span class="text-sm text-gray-600">$173.98</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Merchandise Category -->
                    <div class="category-node">
                        <div class="flex items-center justify-between p-3 bg-green-50 border border-green-200 rounded-lg cursor-pointer hover:bg-green-100" data-category="Merchandise" data-expanded="true">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-green-600 expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                <span class="font-medium text-green-900">üìÅ Merchandise</span>
                            </div>
                            <div class="text-green-800 font-semibold">$70.98</div>
                        </div>
                        <div class="ml-6 mt-2 space-y-2 category-children">
                            <div class="flex items-center justify-between p-2 bg-white border border-gray-200 rounded">
                                <div class="flex items-center">
                                    <span class="w-4 h-4 mr-2"></span>
                                    <span class="text-sm text-gray-700">‚îú‚îÄ‚îÄ Merchandise_Holiday</span>
                                </div>
                                <span class="text-sm text-gray-600">$24.99</span>
                            </div>
                            <div class="flex items-center justify-between p-2 bg-white border border-gray-200 rounded">
                                <div class="flex items-center">
                                    <span class="w-4 h-4 mr-2"></span>
                                    <span class="text-sm text-gray-700">‚îî‚îÄ‚îÄ Merchandise_Apparel</span>
                                </div>
                                <span class="text-sm text-gray-600">$45.99</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Grocery Category -->
                    <div class="category-node">
                        <div class="flex items-center justify-between p-3 bg-purple-50 border border-purple-200 rounded-lg cursor-pointer hover:bg-purple-100" data-category="Grocery" data-expanded="true">
                            <div class="flex items-center">
                                <svg class="w-4 h-4 mr-2 text-purple-600 expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                                <span class="font-medium text-purple-900">üìÅ Grocery</span>
                            </div>
                            <div class="text-purple-800 font-semibold">$12.99</div>
                        </div>
                        <div class="ml-6 mt-2 space-y-2 category-children">
                            <div class="flex items-center justify-between p-2 bg-white border border-gray-200 rounded">
                                <div class="flex items-center">
                                    <span class="w-4 h-4 mr-2"></span>
                                    <span class="text-sm text-gray-700">‚îî‚îÄ‚îÄ Grocery Beverages</span>
                                </div>
                                <span class="text-sm text-gray-600">$12.99</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-blue-600 mr-2 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-blue-800">
                            <strong>Hierarchical Benefits:</strong> This view prevents double counting by showing how items roll up through category hierarchies. Each item's sales are only counted once at their most specific category level.
                        </div>
                    </div>
                </div>
            `;
            
            // Add expand/collapse functionality
            setTimeout(() => {
                const categoryNodes = document.querySelectorAll('.category-node > div[data-category]');
                categoryNodes.forEach(node => {
                    node.addEventListener('click', function() {
                        const children = this.parentNode.querySelector('.category-children');
                        const icon = this.querySelector('.expand-icon');
                        const isExpanded = this.dataset.expanded === 'true';
                        
                        if (isExpanded) {
                            children.classList.add('hidden');
                            this.dataset.expanded = 'false';
                            icon.style.transform = 'rotate(-90deg)';
                        } else {
                            children.classList.remove('hidden');
                            this.dataset.expanded = 'true';
                            icon.style.transform = 'rotate(0deg)';
                        }
                    });
                });
                
                document.getElementById('expandAllBtn').addEventListener('click', function() {
                    categoryNodes.forEach(node => {
                        const children = node.parentNode.querySelector('.category-children');
                        const icon = node.querySelector('.expand-icon');
                        children.classList.remove('hidden');
                        node.dataset.expanded = 'true';
                        icon.style.transform = 'rotate(0deg)';
                    });
                });
                
                document.getElementById('collapseAllBtn').addEventListener('click', function() {
                    categoryNodes.forEach(node => {
                        const children = node.parentNode.querySelector('.category-children');
                        const icon = node.querySelector('.expand-icon');
                        children.classList.add('hidden');
                        node.dataset.expanded = 'false';
                        icon.style.transform = 'rotate(-90deg)';
                    });
                });
            }, 100);
        }

        function buildGroupedView(metricName) {
            // Hide existing content
            document.getElementById('reportCanvasContent').classList.add('hidden');
            document.getElementById('emptyCanvasState').classList.add('hidden');
            document.getElementById('dynamicTableContainer').classList.add('hidden');
            
            // Hide hierarchical container if it exists
            const hierarchicalContainer = document.getElementById('hierarchicalContainer');
            if (hierarchicalContainer) {
                hierarchicalContainer.classList.add('hidden');
            }
            
            // Create or show grouped view container
            let groupedContainer = document.getElementById('groupedContainer');
            if (!groupedContainer) {
                groupedContainer = document.createElement('div');
                groupedContainer.id = 'groupedContainer';
                groupedContainer.className = 'bg-white rounded-lg shadow-sm border border-gray-200 p-6';
                document.querySelector('.flex-1.p-6').appendChild(groupedContainer);
            }
            
            groupedContainer.classList.remove('hidden');
            
            const metricDisplayNames = {
                'itemName': 'Item Name',
                'location': 'Location',
                'reportingCategory': 'Reporting Category',
                'grossSales': 'Gross Sales',
                'netSales': 'Net Sales',
                'qty': 'Quantity'
            };
            
            groupedContainer.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-lg font-medium text-gray-900">Grouped by ${metricDisplayNames[metricName] || metricName}</h2>
                    <button id="editGroupedTableBtn" class="text-sm text-gray-600 hover:text-gray-800 px-3 py-1 border border-gray-300 rounded">Edit Table</button>
                </div>
                
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${metricDisplayNames[metricName] || metricName}</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gross Sales</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Net Sales</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="groupedTableBody">
                            ${generateGroupedTableRows(metricName)}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function generateGroupedTableRows(metricName) {
            const groupedData = {
                'itemName': [
                    ['Firewood 6 Logs', '$89.99', '$85.49', '12'],
                    ['Holiday Candles', '$24.99', '$23.74', '8'],
                    ['Camping Coffee', '$12.99', '$12.34', '24'],
                    ['Kitchen Towels', '$15.99', '$15.19', '15'],
                    ['Outdoor Blanket', '$45.99', '$43.69', '6']
                ],
                'location': [
                    ['Main Store', '$189.95', '$180.45', '65']
                ],
                'reportingCategory': [
                    ['Household Outdoor/Camping', '$89.99', '$85.49', '12'],
                    ['Merchandise_Holiday', '$24.99', '$23.74', '8'],
                    ['Grocery Beverages', '$12.99', '$12.34', '24'],
                    ['Household Kitchen', '$15.99', '$15.19', '15'],
                    ['Merchandise_Apparel', '$45.99', '$43.69', '6']
                ],
                'grossSales': [
                    ['$89.99', '1 item', '$85.49', '12'],
                    ['$45.99', '1 item', '$43.69', '6'],
                    ['$24.99', '1 item', '$23.74', '8'],
                    ['$15.99', '1 item', '$15.19', '15'],
                    ['$12.99', '1 item', '$12.34', '24']
                ],
                'netSales': [
                    ['$85.49', '1 item', '$89.99', '12'],
                    ['$43.69', '1 item', '$45.99', '6'],
                    ['$23.74', '1 item', '$24.99', '8'],
                    ['$15.19', '1 item', '$15.99', '15'],
                    ['$12.34', '1 item', '$12.99', '24']
                ],
                'qty': [
                    ['24 units', '$12.99', '$12.34', 'Camping Coffee'],
                    ['15 units', '$15.99', '$15.19', 'Kitchen Towels'],
                    ['12 units', '$89.99', '$85.49', 'Firewood 6 Logs'],
                    ['8 units', '$24.99', '$23.74', 'Holiday Candles'],
                    ['6 units', '$45.99', '$43.69', 'Outdoor Blanket']
                ]
            };
            
            const data = groupedData[metricName] || groupedData['itemName'];
            
            return data.map(row => `
                <tr>
                    <td class="px-4 py-3 text-sm text-gray-900">${row[0]}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${row[1]}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${row[2]}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${row[3]}</td>
                </tr>
            `).join('');
        }
    </script>
</body>
</html>
